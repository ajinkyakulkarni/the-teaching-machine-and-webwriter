
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>JPanel</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
</head>
<body ondragstart="return false;" ondrop="return false;">
	<h2 align="center">JPanel</h2>
	<h4 align="center">This is a test applet for the project</h4>
	<div id="main" align="center" >
	<img src="/test2/IMAGE_servlet" id="output" style="display:none" alt="" >
	</div>
	<script type="text/javascript">
	$(document).ready(function(){
		$('#output').focus();
		var idx;
		var interval_idx;
		var isDragging = false;
		var src_temp = "data:image/png;base64,";
		var click = false;
		
		$.ajax({
			url:'/test2/JavaRunner',
			method:'GET',
			dataType:'json',
			success:function(json){
				idx = json.index;
				/* alert(idx); */
				$.ajax({
					url:'/test2/IMAGE_servlet',
					method:'GET',
					dataType:'text', 
					contentType: "image/png",
					data:{
						'index':idx
						},
					success:function(data){
						/* alert(data); */
						$('#output').attr('src', src_temp + data);
	    				$('#output').show(); 
					},
					error:function(){
						 alert("error"); 
					}
				});
				
			},
			error:function(){
				alert("e");
			}
		});
		
		function interval(){
			interval_idx = setInterval(function(){
				$.ajax({
					url:'/test2/IMAGE_servlet',
					method:'GET',
					dataType:'text', 
					contentType: "image/png",
					data:{
						'index':idx
						},
					success:function(data){
						/* alert(data); */
						$('#output').attr('src', src_temp + data); 
					},
					error:function(){
						 /* alert("error");  */
					}
				});
			},200);
		};
		
		
		 $('#output').mousedown(function(e) {
				/* var idx = $('#index').val(); */
				click = true;
			    var offset = $(this).offset();
			    var X = Math.floor(e.pageX - offset.left);
			    var Y = Math.floor(e.pageY - offset.top);
			    console.log(X, Y);
			    var url = '/test2/MousePressed';
			    $.getJSON(url, {
			    	x: X,
			    	y: Y,
			    	index: idx 
			    }, function(data){
			    	console.log('submitted');
			    	console.log(data);
			    	
			    	clearInterval(interval_idx);	  
			    	interval();		  
				});  
		})
		.mousemove(function(e){
			if(click == true){
				isDragging = true;
				var offset = $(this).offset();
			    var X = Math.floor(e.pageX - offset.left);
			    var Y = Math.floor(e.pageY - offset.top);
			    console.log(X, Y);
			    var url = '/test2/MouseDragged';
			    $.getJSON(url, {
			    	x: X,
			    	y: Y,
			    	index: idx 
			    }, function(data){
			    	console.log('dragging');
			    });
			}else{return;}
		    
		})
		.mouseup(function(e){
			var indicator_ = 0;
			click = false;
			var offset = $(this).offset();
		    var X = Math.floor(e.pageX - offset.left);
		    var Y = Math.floor(e.pageY - offset.top);
			var wasDragging = isDragging;
			isDragging = false;
			if(!wasDragging){
				indicator_ = 1;
				$.getJSON('/test2/MouseRelease', {
			    	x: X,
			    	y: Y,
			    	index: idx,
			    	indicator: indicator_
			    }, function(data){
			    	console.log('mouseClicked');
			    });
			}else{
				$.getJSON('/test2/MouseRelease', {
			    	x: X,
			    	y: Y,
			    	index: idx,
			    	indicator: indicator_
			    }, function(data){
			    	console.log('mouseDragged');
			    });
			}
		});

		 
		$(window).keypress(function(e){
			 e = e||event;
			 var keyCode;
	                keyCode = e.keyCode;
			 var url = '/test2/KeyClick';
			 var keyChar = String.fromCharCode(e.keyCode||e.charCode);
			 $.getJSON(url,{
				 Code: keyCode,
				 Char: keyChar,
				 index: idx
			 }, function(data){
			    	console.log('keydown successed');
			    	console.log(keyCode, keyChar);
			    	console.log(data);
			 });
		 })
		 .bind("beforeunload",function() { 
		    return confirm("Do you really want to close?" );
		})
		.unload(function(){
			$.getJSON('/test2/Disposed',{
		    	index:idx
			},function(data){});
		}); 
	});

	
	</script>
</body>
</html>